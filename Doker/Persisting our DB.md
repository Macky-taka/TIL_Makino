# Persisting our DB

今のtodoアプリはコンテナの起動ごとにデータが消える。なぜそうなるのか。コンテナがどのように動いているのかを確認しながら理解する。

### The container's filesystem

コンテナはイメージの様々なレイヤーを使用して起動する。
それぞれのコンテナは独自の「スクラッチスペース」を取得し、その中でファイルの生成、更新、削除を行う。それは同じイメージであったとしても、他のコンテナからは見えない、

##### 練習でのセッティング

２つのコンテナを起動して、ファイルを編集する。片方のコンテナでの編集は、別の方では利用できない。
```
docker run -d ubuntu bash -c "shuf -i 1-10000 -n 1 -o /data.txt && tail -f /dev/null"
```

bash shellを起動して２つのコマンドを呼び出す。最初はランダムな数値を/data.txtに書き出す。
２つ目は、コンテナを実行し続けるためにファイルを監視する。
アウトプットとをみれるのでdashboardからターミナルを開く。

### Container Volumes

ここんまでから、コンテナは起動時にイメージの定義から始めることがわかった。コンテナはファイルの作成、更新、削除を行うことができるがコンテナが削除されると失われ、全ての変更はそのコンテナ限りだ。
ボリュームを用いることで変更ができる。ボリュームは、コンテナの特定のファイルパスがホストマシンに接続できる機能がある。
コンテナ内のディテクトりがマウントされているとき、その変更はホストマシンにも影響する。コンテナを再起動しても同じディレクトリをマウントした時、同じファイルを参照できる。
ボリュームには２種類あるが、
named volumeを用いる。
マウントとは、https://www.idcf.jp/words/mount.html

### Persisting our Todo Data

Todoアプリはデータを/etc/todos/todo.dbにあるSQLite Databaseに保存する。
SQLiteはシンプルなリレーショナルデータベースで、一つのファイルに全てのデータを保存する。
大きなデータを扱うのにはベストではないが、小さなデモアプリには有効だ。違うデータベースエンジンに切り替える方法は後述する。<br>

データベースが単一のファイルのため、このファイルをホストで永続化して次のコンテナから参照できるようにすれば、中断して最後のところから再開できる。
ボリュームを作成し、データが保存されているディレクトリに接続（マウント）すれば、データが永続化できる。
コンテナがtodo.dbに書き込むと、ボリューム内のホストに保持される。

これから使うのはnamed volumeだ。これはデータを入れるバケツだと考える。Dockerはディスク上に物理的な領域を確保するので、ボリューム名だけ覚えておけば良い。
ボリュームを利用するときに　、　Dockerが正しいデータが取得されているか検証してくれる。


### Diving into our Volume

named volumeを使った時にDockerがデータを保存する実際の場所はどこか。それはdocker volume inspectコマンドを使用すれば良い。

```
[
    {
        "CreatedAt": "2022-12-01T03:37:17Z",
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/todo-db/_data",
        "Name": "todo-db",
        "Options": {},
        "Scope": "local"
    }
]
```

Mountpoint　は、ディスク上にデータが保存されている。実際の場所である。
ほとんどのマシンでは、ホストからこのディレクトリにアクセスするのにroot権限が必要なことに注意する。

### まとめ
存続したまま再起動できる機能的なアプリケーションを作成できた。
変更を加えるためにイメージを再駆逐するには時間が少しかかりすぎだ。
それを次に行う。





