# Multi-Container Apps

ここまで一つのコンテナのアプリで作業してきた。しかし、アプリケーションにMySQLを追加したい。「MySQLはどこで動かせば良いか。同じコンテナに動かして、別々に起動すれば良いか」
という質問がよくある。一つのコンテナは一つのことを行うべきである。理由以下。
・　APIやフロントエンドをデータベースと異なる方法で拡張させる可能性が高い　<br>
・コンテナを分離することで、バージョンの更新を分離して行える。<br>
・ローカルのデータベース用コンテナを使用することもできるが、本番環境ではデータベースを管理するサービスを使いたいと思うかもしれない。その際、アプリと一緒にデータベースエンジン
を含める必要がない。<br>
・マルチプロセスを起動するにはプロセスマネージャーが必要（コンテナは一つのプロセスしか起動しない）になり、コンテナの起動、停止が複雑になる。
他にも理由がある。
以下のようにアプリケーションをアップデートする。
![imageog Mulit](https://user-images.githubusercontent.com/116047233/204981173-02be6e64-626e-4911-b428-756a34aebfd8.png)


### コンテナ　ネットワーク

コンテナはデフォルトで独立して動作し、同じマシン上の他のプロセスやコンテナについてわからない。では、どうやってコンテナが他のコンテナと通信できるようにすればいいか。それはネットワークだ。ネットワークエンジニアで圧必要はない。
２つのコンテナが同じネットワーク内であれば」お互いに繋がることができる。これを覚えておけば良い。

### MySQLの起動

コンテナをネットワーク上に配置するには２つの方法がある。それは、スタート時に割り当てるもしくは、すでにあるコンテナを接続するである。
今回は、最初にネットワークを作成してから、起動したMySQLコンテナを接続する。

```
docker run -d `
    --network todo-app --network-alias mysql `
    -v todo-mysql-data:/var/lib/mysql `
    -e MYSQL_ROOT_PASSWORD=secret `
    -e MYSQL_DATABASE=todos `
    mysql:5.7
```
```todo-my-sql-data```という名前のボリュームを用い、それをMySQLのデータが保存される```/var/lib/mysql```にマウントした。```docker volume create```は使用していないが、自動で作成した。

### MySQLを接続する

MySQLが起動したのは確認したので、実際に使用してみる。同じネットワークで別のコンテナを起動したら、どうコンテナを探せば良いか。（各コンテナはそれぞれ別のIPアドレスを持っていることを覚えておく）<br>
これを理解するために、ネットワークに関する問題のロラブルシューティングやデバッグに便利なツールがあるnicolaka/netshootコンテナを利用する。
コンテナ内で便利なDNSツールである```DNS```を用いる。
https://atmarkit.itmedia.co.jp/fnetwork/dnstips/012.html
```
; <<>> DiG 9.18.8 <<>> mysql
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61374
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;mysql.                         IN      A

;; ANSWER SECTION:
mysql.                  600     IN      A       172.18.0.2

;; Query time: 38 msec
;; SERVER: 127.0.0.11#53(127.0.0.11) (UDP)
;; WHEN: Thu Dec 01 07:04:34 UTC 2022
;; MSG SIZE  rcvd: 44
```
mysqlは通常有効なホスト名ではないが、Dockerはmysqlというネットワークエリアスを持つコンテナのIPアドレスを解決することができた。

これが意味するのは、todoアプリについてもmysqlという名前のホストに接続するだけで、データベースと通信できることである。

　### MySQLのアプリを動かす

todoアプリでは、MySQL接続設定を指定する環境変数を設定することができる。
・```MYSQL_HOST```:稼働中のMySQLサーバーホスト名
・```MYSQL_USER```:接続のユーザー名
・```MYSQL_PASSWORD```:接続のパスワード
・```MYSQL_DB```:接続後のデータベース

注意
開発環境でコネクション設定に環境変数を使うことは問題ないが、本番環境で動いているアプリケーションで使用することはとても推奨されていない行為だ。

もっと安全な手法として、コンテナのオーケストレーションフレームワークによって提供されるシークレットサポートを利用することがある。
ほとんどの場合、これらのシークレットファイルは稼働しているコンテナにマウントされる。多くのアプリはファイルを含むファイルを指す```_FILE```接尾辞がついた環境変数を大ポートしている。
例として、変数```MYSQL_PASSWORD_FILE```を設定すると、アプリは参照されたファイルの内容をコネクションパスワードとして使用する。Dockerはこれらの環境変数をサポートしない。アプリは環境変数を探して、ファイルの内容を取得する方法を知っておく必要がある。


### まとめ

独立したコンテナで動く外部のデータベースにデータを保存するアプリケーションを作ることができた。コンテナのネットワークについて
少し学び、DNSを使用してサービスの発見を行う方法を理解した。

しかし、



