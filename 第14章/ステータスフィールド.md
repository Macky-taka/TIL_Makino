# ステータスフィールド

現在のユーザーにフォローされているユーザーのマイクロポストの配列を作成し、現在のユーザー自身のマイクロポストと合わせて表示する。

### 動機と計画
ステータスフィードの基本的なアイデアはシンプルだ。_<br>
id 1のユーザーがid 2、7、8、10をフォローしているときのフィード
![Image of feed](https://railstutorial.jp/chapters/6.0/images/figures/user_feed.png)
テストから書く。
このテストで重要なことは、フィードに必要な３つの条件を満たすことである。
1）フォローしているユーザーのマイクロポストがフィードに含まれていること。<br>
2）自分自身のマイクロポストもフィードに含まれていること。<br>
3）フォローしていないユーザーのマイクロポストがフィードに含まれていないこと<br>

### フィードを初めて実装する

最初に、このフィードで必要なクエリについて考える。ここで必要なのは、micropostsテーブルから、
あるユーザー（つまり自分自身）がフォローしているユーザーに対応するidを持つマイクロポストをすべて選択（select）することである。

```
Micropost.where("user_id IN (?) OR user_id = ?", following_ids, id)
```
SQLが```IN```をサポートしているのでオッケーで、idの集合の内包（set inclusion）に対してテストをおこなう。
そしてフォローされているユーザーに対応するidの配列が必要だが、```map```を用いる。

```
>> [1, 2, 3, 4].map(&:to_s)
=> ["1", "2", "3", "4"]
```
```
>> [1, 2, 3, 4].map(&:to_s).join(', ')
=> "1, 2, 3, 4"
```
```
>> User.first.following_ids
=> [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,
23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41,
42, 43, 44, 45, 46, 47, 48, 49, 50, 51]
```
following_idsメソッドは、has_many :followingの関連付けをしたときにActive Recordが自動生成した。


### サブセレクト

投稿されたマイクロポストの数が膨大になったときにうまくスケールしないことを防止するために、
フォローしているユーザー数に応じてスケールできるように、ステータスフィードを改善する。


