# 認可
ウェブアプリケーションの文脈では、認証（authentication）はサイトのユーザーを識別することであり、認可（authorization）はそのユーザーが実行可能な操作を管理することである。
edit、updateは動作しているが、どのユーザーでもあらゆるアクションにアクセスできるため、誰でも（ログインしていないユーザーでも）ユーザー情報を編集できてしまう。
そのためにユーザーにログインを要求し、かつ自分以外のユーザー情報を変更できないように制御する。
ログインしていないユーザーが保護されたページにアクセスしようとした際のケースについて対処する。具体的には、ログインページに転送して、そのときに分かりやすいメッセージも表示するようにする。
一方で、許可されていないページに対してアクセスするログイン済みのユーザーはルートURLにリダイレクトさせる。
### ユーザーにログインを要求する
転送の仕組みを実装するときはUsersコントローラの中でbeforeフィルターを使う。```before_action```メソッドを使って何らかの処理が実行される直前に特定のメソッドを実行する
### 正しいユーザーを要求する
ユーザーが自分の情報だけを編集できるようにする必要がある。セキュリティモデルが正しく実装されている確信を持つために、テスト駆動開発で進める。
はユーザーの情報が互いに編集できないことを確認するために、サンプルユーザーをもう一人追加する。

updateアクションにpatchリクエストを送って不正に更新しようとする行為を防止するためにeditアクションとupdateアクションを両方とも保護する必要がある。

# フレンドリーフォワーディング
保護されたページにアクセスしようとすると、問題無用で自分のプロフィールページに移動させられてしまう問題がある。フレンドリーフォワーディングのテストコードは、シンプルに書くことができて、
例えばログインした後に編集ページへアクセスする、という順序を逆にしてあげる。
テストとして、編集ページにアクセス後、ログインし、その後編集ページにリダイレクトされているかどうかを確認する。
テスト終了後に、ユーザーを希望のページに転送するには、リクエスト時点のページをどこかに保存しておき、その場所にリダイレクトさせる必要がある。
この動作のために```store_location```と```redirect_back_or```の2つのメソッドを用いる。
```store_location```メソッドでは、 リクエストが送られたURLを```session```変数の```:forwarding_urlキー```に格納し、```GET```リクエストが送られた時だけ格納する。
例えばログインしていないユーザーがフォームを使って送信した場合、転送先のURLを保存させないようにできる。
ユーザがセッション用のcookieを手動で削除してフォームから送信するケースなどがあり得る。```POST```や ```PATCH```、```DELETE```
リクエストを期待しているURLに対して、（リダイレクトを通して）```GET```リクエストが送られ、エラーが生じる。
```session[:forwarding_url] || default```
```nil```でなければ```session[:forwarding_url]```を評価し、そうでなければデフォルトのURLを使う。
